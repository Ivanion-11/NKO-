<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Панель управления НКО | AtomHeart Heroes</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
</head>
<body class="bg-gray-900">
    <!-- Красивый фон -->
    <div class="background-wrapper"></div>
    <div class="particles-container">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>
    
    <custom-navbar></custom-navbar>
    
    <main class="main-content container mx-auto px-4 py-8">
        <div class="max-w-6xl mx-auto">
            <!-- Кнопка назад -->
            <div class="mb-8 fade-in-up">
                <a href="index.html" class="btn-back btn-wave inline-flex items-center">
                    <i data-feather="arrow-left" class="w-5 h-5"></i>
                    Назад на главную
                </a>
            </div>

            <!-- Заголовок -->
            <div class="text-center mb-12 fade-in-up">
                <h1 class="text-5xl md:text-6xl font-black mb-6 gradient-text leading-tight">
                    Панель управления НКО
                </h1>
                <p class="text-xl text-gray-300 max-w-2xl mx-auto font-medium">
                    Управляйте вашими мероприятиями и организацией
                </p>
            </div>

            <!-- Информация об организации -->
            <div class="card p-8 mb-8 fade-in-up">
                <div class="flex flex-col md:flex-row items-start md:items-center justify-between">
                    <div class="flex items-center mb-6 md:mb-0">
                        <div class="w-20 h-20 rounded-2xl bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center text-white text-2xl font-bold mr-6 shadow-lg" id="orgLogo">
                            ЭД
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800" id="orgNameDisplay">Эко-Дубна</h2>
                            <p class="text-gray-600" id="orgInfoDisplay">Фонд • Дубна, Московская область</p>
                        </div>
                    </div>
                    <div class="bg-green-100 text-green-800 px-4 py-2 rounded-full text-sm font-semibold">
                        ✅ Организация подтверждена
                    </div>
                </div>
            </div>

            <div class="grid lg:grid-cols-3 gap-8">
                <!-- Боковая панель -->
                <div class="lg:col-span-1">
                    <!-- Быстрые действия -->
                    <div class="card p-6 mb-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Быстрые действия</h3>
                        <button onclick="openEventModal()" class="btn btn-primary btn-wave btn-icon w-full mb-3">
                            <i data-feather="plus" class="w-5 h-5"></i>
                            Новое мероприятие
                        </button>
                        <button onclick="openStatisticsModal()" class="btn btn-glass btn-icon w-full mb-3">
                            <i data-feather="bar-chart" class="w-5 h-5"></i>
                            Статистика
                        </button>
                        <button onclick="openProfileModal()" class="btn btn-border btn-icon w-full">
                            <i data-feather="edit" class="w-5 h-5"></i>
                            Редактировать профиль
                        </button>
                    </div>

                    <!-- Статистика -->
                    <div class="card p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Статистика</h3>
                        <div class="space-y-4" id="statsSummary">
                            <!-- Статистика будет обновляться динамически -->
                        </div>
                    </div>

                    <!-- Зарегистрированные волонтеры -->
                    <div class="card p-6 mt-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Волонтеры</h3>
                        <div id="volunteersList">
                            <!-- Список волонтеров будет здесь -->
                        </div>
                    </div>
                </div>

                <!-- Основной контент -->
                <div class="lg:col-span-2">
                    <!-- Заголовок мероприятий -->
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-white">Ваши мероприятия</h2>
                        <button onclick="openEventModal()" class="btn btn-primary btn-wave btn-icon">
                            <i data-feather="plus" class="w-5 h-5"></i>
                            Добавить мероприятие
                        </button>
                    </div>

                    <!-- Список мероприятий -->
                    <div id="eventsList" class="space-y-6">
                        <!-- Мероприятия будут загружаться здесь -->
                    </div>

                    <!-- Сообщение если нет мероприятий -->
                    <div id="emptyState" class="card p-12 text-center hidden">
                        <div class="w-20 h-20 mx-auto mb-6 bg-gradient-to-r from-gray-300 to-gray-400 rounded-2xl flex items-center justify-center text-white text-2xl">
                            <i data-feather="calendar" class="w-10 h-10"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-3">Пока нет мероприятий</h3>
                        <p class="text-gray-600 mb-6">Создайте ваше первое мероприятие и привлекайте волонтеров</p>
                        <button onclick="openEventModal()" class="btn btn-primary btn-wave btn-icon">
                            <i data-feather="plus" class="w-5 h-5"></i>
                            Создать мероприятие
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Модальное окно создания/редактирования мероприятия -->
    <div id="eventModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800" id="eventModalTitle">Создание мероприятия</h3>
                <button onclick="closeEventModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-feather="x" class="w-6 h-6"></i>
                </button>
            </div>

            <form id="eventForm" class="space-y-6">
                <input type="hidden" id="eventId" name="eventId">
                
                <!-- Название мероприятия -->
                <div>
                    <label for="eventTitle" class="block text-sm font-semibold text-gray-700 mb-3">Название мероприятия *</label>
                    <input type="text" id="eventTitle" name="eventTitle" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300"
                           placeholder="Например: Экологический субботник">
                </div>

                <!-- Описание -->
                <div>
                    <label for="eventDescription" class="block text-sm font-semibold text-gray-700 mb-3">Описание *</label>
                    <textarea id="eventDescription" name="eventDescription" rows="4" required
                              class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300"
                              placeholder="Опишите ваше мероприятие..."></textarea>
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <!-- Дата -->
                    <div>
                        <label for="eventDate" class="block text-sm font-semibold text-gray-700 mb-3">Дата проведения *</label>
                        <input type="date" id="eventDate" name="eventDate" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300">
                    </div>

                    <!-- Категория -->
                    <div>
                        <label for="eventCategory" class="block text-sm font-semibold text-gray-700 mb-3">Категория *</label>
                        <select id="eventCategory" name="eventCategory" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300">
                            <option value="">Выберите категорию</option>
                            <option value="Экология">Экология</option>
                            <option value="Спорт">Спорт</option>
                            <option value="Образование">Образование</option>
                            <option value="Социальная помощь">Социальная помощь</option>
                            <option value="Благоустройство">Благоустройство</option>
                            <option value="Культура">Культура</option>
                        </select>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <!-- Город -->
                    <div>
                        <label for="eventCity" class="block text-sm font-semibold text-gray-700 mb-3">Город *</label>
                        <select id="eventCity" name="eventCity" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300">
                            <option value="">Выберите город</option>
                            <option value="Дубна">Дубна</option>
                            <option value="Сосновый Бор">Сосновый Бор</option>
                            <option value="Новоуральск">Новоуральск</option>
                            <option value="Озёрск">Озёрск</option>
                            <option value="Обнинск">Обнинск</option>
                            <option value="Саров">Саров</option>
                        </select>
                    </div>

                    <!-- Адрес -->
                    <div>
                        <label for="eventAddress" class="block text-sm font-semibold text-gray-700 mb-3">Адрес *</label>
                        <input type="text" id="eventAddress" name="eventAddress" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300"
                               placeholder="Например: Городской парк">
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <!-- Максимальное количество участников -->
                    <div>
                        <label for="eventMaxParticipants" class="block text-sm font-semibold text-gray-700 mb-3">Макс. участников</label>
                        <input type="number" id="eventMaxParticipants" name="eventMaxParticipants" min="1" max="1000" value="50"
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300">
                    </div>

                    <!-- Требования -->
                    <div>
                        <label for="eventRequirements" class="block text-sm font-semibold text-gray-700 mb-3">Требования</label>
                        <input type="text" id="eventRequirements" name="eventRequirements"
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300"
                               placeholder="Например: Удобная одежда, перчатки">
                    </div>
                </div>

                <!-- Публикация для волонтеров -->
                <div class="flex items-center justify-between p-4 bg-blue-50 rounded-xl">
                    <div class="flex items-center">
                        <i data-feather="globe" class="w-5 h-5 text-blue-600 mr-3"></i>
                        <div>
                            <div class="font-semibold text-gray-800">Опубликовать для волонтеров</div>
                            <div class="text-sm text-gray-600">Событие увидят все волонтеры на главной странице</div>
                        </div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="eventPublic" name="eventPublic" class="sr-only peer" checked>
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>

                <!-- Загрузка фото -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-3">Фото мероприятия</label>
                    <div class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center transition-all duration-300 hover:border-blue-500">
                        <input type="file" id="eventImage" name="eventImage" accept="image/*" 
                               class="hidden" onchange="previewImage(event)">
                        <div id="imageUploadArea" class="cursor-pointer">
                            <i data-feather="upload" class="w-12 h-12 text-gray-400 mx-auto mb-3"></i>
                            <p class="text-gray-600 mb-2">Нажмите для загрузки фото</p>
                            <p class="text-sm text-gray-500">PNG, JPG до 5MB</p>
                        </div>
                        <div id="imagePreview" class="hidden mt-4">
                            <img id="preview" class="w-full h-48 object-cover rounded-lg">
                            <button type="button" onclick="removeImage()" class="btn btn-sm btn-border mt-2">
                                <i data-feather="trash" class="w-4 h-4"></i>
                                Удалить фото
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Кнопки -->
                <div class="flex gap-4 pt-4">
                    <button type="button" onclick="closeEventModal()" class="btn btn-border flex-1">
                        Отмена
                    </button>
                    <button type="submit" class="btn btn-primary btn-wave btn-icon flex-1">
                        <i data-feather="save" class="w-5 h-5"></i>
                        <span id="eventSubmitText">Создать мероприятие</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Модальное окно статистики -->
    <div id="statisticsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl p-8 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">Статистика организации</h3>
                <button onclick="closeStatisticsModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-feather="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="card p-6 text-center">
                    <div class="text-3xl font-bold text-blue-600 mb-2" id="statTotalEvents">0</div>
                    <div class="text-gray-600">Всего мероприятий</div>
                </div>
                <div class="card p-6 text-center">
                    <div class="text-3xl font-bold text-green-600 mb-2" id="statActiveEvents">0</div>
                    <div class="text-gray-600">Активные</div>
                </div>
                <div class="card p-6 text-center">
                    <div class="text-3xl font-bold text-gray-600 mb-2" id="statCompletedEvents">0</div>
                    <div class="text-gray-600">Завершенные</div>
                </div>
                <div class="card p-6 text-center">
                    <div class="text-3xl font-bold text-purple-600 mb-2" id="statTotalParticipants">0</div>
                    <div class="text-gray-600">Участников</div>
                </div>
            </div>

            <div class="card p-6">
                <h4 class="text-lg font-bold text-gray-800 mb-4">Статистика по категориям</h4>
                <div id="categoryStats" class="space-y-3">
                    <!-- Статистика по категориям будет здесь -->
                </div>
            </div>

            <!-- Список волонтеров -->
            <div class="card p-6 mt-6">
                <h4 class="text-lg font-bold text-gray-800 mb-4">Зарегистрированные волонтеры</h4>
                <div id="detailedVolunteersList">
                    <!-- Подробный список волонтеров -->
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно редактирования профиля -->
    <div id="profileModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">Редактирование профиля</h3>
                <button onclick="closeProfileModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-feather="x" class="w-6 h-6"></i>
                </button>
            </div>

            <form id="profileForm" class="space-y-6">
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label for="profileName" class="block text-sm font-semibold text-gray-700 mb-3">Название организации *</label>
                        <input type="text" id="profileName" name="profileName" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300">
                    </div>
                    
                    <div>
                        <label for="profileType" class="block text-sm font-semibold text-gray-700 mb-3">Тип организации *</label>
                        <select id="profileType" name="profileType" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300">
                            <option value="Фонд">Фонд</option>
                            <option value="Ассоциация">Ассоциация</option>
                            <option value="Общественная организация">Общественная организация</option>
                            <option value="Благотворительная организация">Благотворительная организация</option>
                            <option value="Другое">Другое</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label for="profileCity" class="block text-sm font-semibold text-gray-700 mb-3">Город *</label>
                    <select id="profileCity" name="profileCity" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300">
                        <option value="Дубна, Московская область">Дубна, Московская область</option>
                        <option value="Сосновый Бор, Ленинградская область">Сосновый Бор, Ленинградская область</option>
                        <option value="Новоуральск, Свердловская область">Новоуральск, Свердловская область</option>
                        <option value="Озёрск, Челябинская область">Озёрск, Челябинская область</option>
                    </select>
                </div>

                <div>
                    <label for="profileDescription" class="block text-sm font-semibold text-gray-700 mb-3">Описание деятельности</label>
                    <textarea id="profileDescription" name="profileDescription" rows="4"
                              class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300"></textarea>
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label for="profileContact" class="block text-sm font-semibold text-gray-700 mb-3">Контактное лицо *</label>
                        <input type="text" id="profileContact" name="profileContact" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300">
                    </div>
                    
                    <div>
                        <label for="profileEmail" class="block text-sm font-semibold text-gray-700 mb-3">Email *</label>
                        <input type="email" id="profileEmail" name="profileEmail" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300">
                    </div>
                </div>

                <div>
                    <label for="profilePhone" class="block text-sm font-semibold text-gray-700 mb-3">Телефон</label>
                    <input type="tel" id="profilePhone" name="profilePhone"
                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300">
                </div>

                <!-- Кнопки -->
                <div class="flex gap-4 pt-4">
                    <button type="button" onclick="closeProfileModal()" class="btn btn-border flex-1">
                        Отмена
                    </button>
                    <button type="submit" class="btn btn-primary btn-wave btn-icon flex-1">
                        <i data-feather="save" class="w-5 h-5"></i>
                        Сохранить изменения
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <custom-footer></custom-footer>
    
    <script src="components/navbar.js"></script>
    <script src="components/footer.js"></script>
    <script src="script.js"></script>
    <script>
        feather.replace();
        
        // Данные организации по умолчанию
        let organizationData = {
            name: "Эко-Дубна",
            type: "Фонд",
            city: "Дубна, Московская область",
            description: "Организация, занимающаяся экологическими инициативами и защитой окружающей среды",
            contact: "Иван Иванов",
            email: "eco-dubna@mail.ru",
            phone: "+7 (999) 123-45-67"
        };

        // Загрузка данных при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            loadOrganizationData();
            loadEvents();
            updateStatistics();
            loadVolunteersList();
        });

        // Функции модального окна мероприятий
        function openEventModal(eventId = null) {
            const modal = document.getElementById('eventModal');
            const title = document.getElementById('eventModalTitle');
            const submitText = document.getElementById('eventSubmitText');
            
            if (eventId) {
                // Режим редактирования
                title.textContent = 'Редактирование мероприятия';
                submitText.textContent = 'Сохранить изменения';
                loadEventData(eventId);
            } else {
                // Режим создания
                title.textContent = 'Создание мероприятия';
                submitText.textContent = 'Создать мероприятие';
                document.getElementById('eventForm').reset();
                document.getElementById('eventId').value = '';
                document.getElementById('eventMaxParticipants').value = '50';
                document.getElementById('eventPublic').checked = true;
                document.getElementById('imagePreview').classList.add('hidden');
                document.getElementById('imageUploadArea').classList.remove('hidden');
            }
            
            modal.classList.remove('hidden');
        }

        function closeEventModal() {
            document.getElementById('eventModal').classList.add('hidden');
        }

        function loadEventData(eventId) {
            const events = JSON.parse(localStorage.getItem('nkoEvents') || '[]');
            const event = events.find(e => e.id == eventId);
            
            if (event) {
                document.getElementById('eventId').value = event.id;
                document.getElementById('eventTitle').value = event.title;
                document.getElementById('eventDescription').value = event.description;
                document.getElementById('eventDate').value = event.date;
                document.getElementById('eventCategory').value = event.category;
                document.getElementById('eventCity').value = event.city;
                document.getElementById('eventAddress').value = event.address;
                document.getElementById('eventMaxParticipants').value = event.maxParticipants || 50;
                document.getElementById('eventRequirements').value = event.requirements || '';
                document.getElementById('eventPublic').checked = event.isPublic !== false;
                
                // Загрузка изображения
                if (event.image && event.image !== 'https://images.unsplash.com/photo-1542601906990-b4d3fb778b09?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80') {
                    document.getElementById('preview').src = event.image;
                    document.getElementById('imagePreview').classList.remove('hidden');
                    document.getElementById('imageUploadArea').classList.add('hidden');
                }
            }
        }

        // Функции модального окна статистики
        function openStatisticsModal() {
            updateStatisticsModal();
            document.getElementById('statisticsModal').classList.remove('hidden');
        }

        function closeStatisticsModal() {
            document.getElementById('statisticsModal').classList.add('hidden');
        }

        // Функции модального окна профиля
        function openProfileModal() {
            loadProfileData();
            document.getElementById('profileModal').classList.remove('hidden');
        }

        function closeProfileModal() {
            document.getElementById('profileModal').classList.add('hidden');
        }

        function loadProfileData() {
            document.getElementById('profileName').value = organizationData.name;
            document.getElementById('profileType').value = organizationData.type;
            document.getElementById('profileCity').value = organizationData.city;
            document.getElementById('profileDescription').value = organizationData.description;
            document.getElementById('profileContact').value = organizationData.contact;
            document.getElementById('profileEmail').value = organizationData.email;
            document.getElementById('profilePhone').value = organizationData.phone;
        }

        // Загрузка данных организации
        function loadOrganizationData() {
            const savedData = localStorage.getItem('nkoOrganization');
            if (savedData) {
                organizationData = JSON.parse(savedData);
            }
            
            document.getElementById('orgNameDisplay').textContent = organizationData.name;
            document.getElementById('orgInfoDisplay').textContent = `${organizationData.type} • ${organizationData.city}`;
            document.getElementById('orgLogo').textContent = organizationData.name.substring(0, 2);
        }

        // Предпросмотр изображения
        function previewImage(event) {
            const input = event.target;
            const preview = document.getElementById('preview');
            const uploadArea = document.getElementById('imageUploadArea');
            const previewArea = document.getElementById('imagePreview');

            if (input.files && input.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    uploadArea.classList.add('hidden');
                    previewArea.classList.remove('hidden');
                }
                
                reader.readAsDataURL(input.files[0]);
            }
        }

        function removeImage() {
            document.getElementById('eventImage').value = '';
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('imageUploadArea').classList.remove('hidden');
        }

        // Обработка формы мероприятия
        document.getElementById('eventForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const eventId = document.getElementById('eventId').value;
            
            if (eventId) {
                updateEvent(eventId);
            } else {
                createEvent();
            }
        });

        // Обработка формы профиля
        document.getElementById('profileForm').addEventListener('submit', function(e) {
            e.preventDefault();
            saveProfile();
        });

        // Создание мероприятия
        function createEvent() {
            const formData = {
                id: Date.now(),
                title: document.getElementById('eventTitle').value,
                description: document.getElementById('eventDescription').value,
                date: document.getElementById('eventDate').value,
                category: document.getElementById('eventCategory').value,
                city: document.getElementById('eventCity').value,
                address: document.getElementById('eventAddress').value,
                participants: 0,
                maxParticipants: parseInt(document.getElementById('eventMaxParticipants').value) || 50,
                organization: organizationData.name,
                contactEmail: organizationData.email,
                contactPhone: organizationData.phone,
                requirements: document.getElementById('eventRequirements').value,
                image: document.getElementById('preview').src || 'https://images.unsplash.com/photo-1542601906990-b4d3fb778b09?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80',
                createdAt: new Date().toISOString(),
                status: 'active',
                isPublic: document.getElementById('eventPublic').checked
            };

            const events = JSON.parse(localStorage.getItem('nkoEvents') || '[]');
            events.push(formData);
            localStorage.setItem('nkoEvents', JSON.stringify(events));

            // Публикуем событие для волонтеров если выбрана опция
            if (formData.isPublic) {
                eventsSystem.publishEvent(formData);
            }

            showNotification('Мероприятие успешно создано!', 'success');
            closeEventModal();
            loadEvents();
            updateStatistics();
            loadVolunteersList();
        }

        // Обновление мероприятия
        function updateEvent(eventId) {
            const events = JSON.parse(localStorage.getItem('nkoEvents') || '[]');
            const eventIndex = events.findIndex(e => e.id == eventId);
            
            if (eventIndex !== -1) {
                const wasPublic = events[eventIndex].isPublic;
                const isNowPublic = document.getElementById('eventPublic').checked;
                
                events[eventIndex] = {
                    ...events[eventIndex],
                    title: document.getElementById('eventTitle').value,
                    description: document.getElementById('eventDescription').value,
                    date: document.getElementById('eventDate').value,
                    category: document.getElementById('eventCategory').value,
                    city: document.getElementById('eventCity').value,
                    address: document.getElementById('eventAddress').value,
                    maxParticipants: parseInt(document.getElementById('eventMaxParticipants').value) || 50,
                    requirements: document.getElementById('eventRequirements').value,
                    image: document.getElementById('preview').src || events[eventIndex].image,
                    isPublic: isNowPublic
                };

                localStorage.setItem('nkoEvents', JSON.stringify(events));

                // Обновляем публичное событие если нужно
                if (wasPublic && !isNowPublic) {
                    // Удаляем из публичных
                    eventsSystem.unpublishEvent(eventId);
                } else if (!wasPublic && isNowPublic) {
                    // Добавляем в публичные
                    eventsSystem.publishEvent(events[eventIndex]);
                } else if (wasPublic && isNowPublic) {
                    // Обновляем публичное событие
                    eventsSystem.updatePublicEvent(eventId, events[eventIndex]);
                }

                showNotification('Мероприятие успешно обновлено!', 'success');
                closeEventModal();
                loadEvents();
                updateStatistics();
                loadVolunteersList();
            }
        }

        // Сохранение профиля
        function saveProfile() {
            organizationData = {
                name: document.getElementById('profileName').value,
                type: document.getElementById('profileType').value,
                city: document.getElementById('profileCity').value,
                description: document.getElementById('profileDescription').value,
                contact: document.getElementById('profileContact').value,
                email: document.getElementById('profileEmail').value,
                phone: document.getElementById('profilePhone').value
            };

            localStorage.setItem('nkoOrganization', JSON.stringify(organizationData));
            loadOrganizationData();
            
            // Обновляем организацию в существующих мероприятиях
            const events = JSON.parse(localStorage.getItem('nkoEvents') || '[]');
            events.forEach(event => {
                event.organization = organizationData.name;
                event.contactEmail = organizationData.email;
                event.contactPhone = organizationData.phone;
            });
            localStorage.setItem('nkoEvents', JSON.stringify(events));
            
            // Обновляем публичные события
            const publicEvents = eventsSystem.getPublicEvents();
            publicEvents.forEach(event => {
                if (event.organization === organizationData.name) {
                    event.organization = organizationData.name;
                    event.contactEmail = organizationData.email;
                    event.contactPhone = organizationData.phone;
                }
            });
            eventsSystem.savePublicEvents(publicEvents);
            
            showNotification('Профиль успешно обновлен!', 'success');
            closeProfileModal();
            loadEvents();
        }

        // Загрузка мероприятий
        function loadEvents() {
            const events = JSON.parse(localStorage.getItem('nkoEvents') || '[]');
            const eventsList = document.getElementById('eventsList');
            const emptyState = document.getElementById('emptyState');

            if (events.length === 0) {
                eventsList.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            
            // Сортируем мероприятия по дате (новые сначала)
            events.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            eventsList.innerHTML = events.map(event => `
                <div class="card group hover:scale-105 transition-all duration-300">
                    <div class="relative overflow-hidden rounded-t-2xl">
                        <img src="${event.image}" 
                             alt="${event.title}" 
                             class="w-full h-48 object-cover transition-transform duration-300 group-hover:scale-110">
                        <div class="absolute top-4 left-4 ${getCategoryColorClass(event.category)} text-white px-3 py-1 rounded-full text-sm font-semibold">
                            ${event.category}
                        </div>
                        <div class="absolute top-4 right-4 bg-white/90 backdrop-blur-sm text-gray-800 px-3 py-1 rounded-full text-sm font-semibold">
                            ${formatDate(event.date)}
                        </div>
                        <div class="absolute bottom-4 left-4 bg-green-500 text-white px-3 py-1 rounded-full text-sm font-semibold">
                            ${event.participants} участников
                        </div>
                        ${event.isPublic ? `
                        <div class="absolute bottom-4 right-4 bg-blue-500 text-white px-3 py-1 rounded-full text-sm font-semibold">
                            Опубликовано
                        </div>
                        ` : `
                        <div class="absolute bottom-4 right-4 bg-gray-500 text-white px-3 py-1 rounded-full text-sm font-semibold">
                            Черновик
                        </div>
                        `}
                    </div>
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-3 group-hover:text-blue-600 transition-colors">
                            ${event.title}
                        </h3>
                        <div class="flex items-center text-gray-600 mb-3">
                            <i data-feather="map-pin" class="w-4 h-4 mr-2"></i>
                            <span class="text-sm">${event.address}, ${event.city}</span>
                        </div>
                        <p class="text-gray-600 text-sm mb-4 leading-relaxed">
                            ${event.description}
                        </p>
                        <div class="flex items-center justify-between">
                            <span class="text-blue-600 font-semibold">${event.organization}</span>
                            <div class="flex gap-2">
                                <button onclick="openEventModal(${event.id})" class="btn btn-glass btn-sm">
                                    <i data-feather="edit" class="w-4 h-4"></i>
                                </button>
                                <button onclick="viewEventVolunteers(${event.id})" class="btn btn-glass btn-sm">
                                    <i data-feather="users" class="w-4 h-4"></i>
                                </button>
                                <button onclick="deleteEvent(${event.id})" class="btn btn-glass btn-sm">
                                    <i data-feather="trash" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            feather.replace();
        }

        // Просмотр волонтеров мероприятия
        function viewEventVolunteers(eventId) {
            const publicEvents = eventsSystem.getPublicEvents();
            const event = publicEvents.find(e => e.id == eventId);
            
            if (event && event.registeredVolunteers.length > 0) {
                let volunteersHTML = '<h4 class="font-bold text-gray-800 mb-3">Зарегистрированные волонтеры:</h4>';
                event.registeredVolunteers.forEach(volunteer => {
                    volunteersHTML += `
                        <div class="flex items-center justify-between py-2 border-b border-gray-200">
                            <div>
                                <div class="font-medium">${volunteer.fullName}</div>
                                <div class="text-sm text-gray-600">${volunteer.email}</div>
                            </div>
                            <div class="text-sm text-gray-500">
                                ${formatDate(volunteer.registeredAt)}
                            </div>
                        </div>
                    `;
                });
                alert(volunteersHTML);
            } else {
                showNotification('На это мероприятие еще никто не зарегистрировался', 'info');
            }
        }

        // Удаление мероприятия
        function deleteEvent(id) {
            if (confirm('Вы уверены, что хотите удалить это мероприятие?')) {
                const events = JSON.parse(localStorage.getItem('nkoEvents') || '[]');
                const filteredEvents = events.filter(event => event.id !== id);
                localStorage.setItem('nkoEvents', JSON.stringify(filteredEvents));
                
                // Удаляем также из публичных событий
                eventsSystem.unpublishEvent(id);
                
                loadEvents();
                updateStatistics();
                loadVolunteersList();
                showNotification('Мероприятие удалено', 'success');
            }
        }

        // Загрузка списка волонтеров
        function loadVolunteersList() {
            const publicEvents = eventsSystem.getPublicEvents();
            const orgEvents = publicEvents.filter(event => event.organization === organizationData.name);
            
            // Собираем всех уникальных волонтеров
            const allVolunteers = new Map();
            orgEvents.forEach(event => {
                event.registeredVolunteers.forEach(volunteer => {
                    if (!allVolunteers.has(volunteer.email)) {
                        allVolunteers.set(volunteer.email, {
                            ...volunteer,
                            eventsCount: 1
                        });
                    } else {
                        allVolunteers.get(volunteer.email).eventsCount++;
                    }
                });
            });

            const volunteersList = document.getElementById('volunteersList');
            const detailedList = document.getElementById('detailedVolunteersList');
            
            if (allVolunteers.size === 0) {
                volunteersList.innerHTML = '<p class="text-gray-600 text-sm">Пока нет зарегистрированных волонтеров</p>';
                if (detailedList) {
                    detailedList.innerHTML = '<p class="text-gray-600 text-sm">Пока нет зарегистрированных волонтеров</p>';
                }
                return;
            }

            // Краткий список для боковой панели
            volunteersList.innerHTML = Array.from(allVolunteers.values()).slice(0, 5).map(volunteer => `
                <div class="flex items-center justify-between py-2">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white text-sm font-bold mr-3">
                            ${volunteer.fullName.charAt(0)}
                        </div>
                        <div>
                            <div class="text-sm font-medium text-gray-800">${volunteer.fullName}</div>
                            <div class="text-xs text-gray-500">${volunteer.eventsCount} мероприятий</div>
                        </div>
                    </div>
                </div>
            `).join('');

            // Подробный список для модального окна статистики
            if (detailedList) {
                detailedList.innerHTML = Array.from(allVolunteers.values()).map(volunteer => `
                    <div class="flex items-center justify-between py-3 border-b border-gray-200">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold mr-4">
                                ${volunteer.fullName.charAt(0)}
                            </div>
                            <div>
                                <div class="font-medium text-gray-800">${volunteer.fullName}</div>
                                <div class="text-sm text-gray-600">${volunteer.email}</div>
                                <div class="text-xs text-gray-500">${volunteer.phone || 'Телефон не указан'}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-semibold text-blue-600">${volunteer.eventsCount}</div>
                            <div class="text-xs text-gray-500">мероприятий</div>
                        </div>
                    </div>
                `).join('');
            }
        }

        // Обновление статистики
        function updateStatistics() {
            const events = JSON.parse(localStorage.getItem('nkoEvents') || '[]');
            const now = new Date();
            
            const totalEvents = events.length;
            const activeEvents = events.filter(event => new Date(event.date) >= now).length;
            const completedEvents = events.filter(event => new Date(event.date) < now).length;
            const totalParticipants = events.reduce((sum, event) => sum + (event.participants || 0), 0);

            // Обновляем боковую панель статистики
            document.getElementById('statsSummary').innerHTML = `
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">Всего мероприятий</span>
                    <span class="font-bold text-blue-600">${totalEvents}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">Активные</span>
                    <span class="font-bold text-green-600">${activeEvents}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">Завершенные</span>
                    <span class="font-bold text-gray-600">${completedEvents}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">Участников</span>
                    <span class="font-bold text-purple-600">${totalParticipants}</span>
                </div>
            `;
        }

        // Обновление модального окна статистики
        function updateStatisticsModal() {
            const events = JSON.parse(localStorage.getItem('nkoEvents') || '[]');
            const now = new Date();
            
            const totalEvents = events.length;
            const activeEvents = events.filter(event => new Date(event.date) >= now).length;
            const completedEvents = events.filter(event => new Date(event.date) < now).length;
            const totalParticipants = events.reduce((sum, event) => sum + (event.participants || 0), 0);

            // Обновляем основные показатели
            document.getElementById('statTotalEvents').textContent = totalEvents;
            document.getElementById('statActiveEvents').textContent = activeEvents;
            document.getElementById('statCompletedEvents').textContent = completedEvents;
            document.getElementById('statTotalParticipants').textContent = totalParticipants;

            // Статистика по категориям
            const categoryStats = {};
            events.forEach(event => {
                if (!categoryStats[event.category]) {
                    categoryStats[event.category] = { count: 0, participants: 0 };
                }
                categoryStats[event.category].count++;
                categoryStats[event.category].participants += (event.participants || 0);
            });

            let categoryHTML = '';
            for (const [category, stats] of Object.entries(categoryStats)) {
                categoryHTML += `
                    <div class="flex justify-between items-center py-2 border-b border-gray-200">
                        <span class="font-medium text-gray-700">${category}</span>
                        <div class="text-right">
                            <div class="text-sm text-gray-600">${stats.count} мероприятий</div>
                            <div class="text-xs text-gray-500">${stats.participants} участников</div>
                        </div>
                    </div>
                `;
            }

            document.getElementById('categoryStats').innerHTML = categoryHTML || '<p class="text-gray-500 text-center">Нет данных</p>';
            
            // Обновляем список волонтеров
            loadVolunteersList();
        }

        // Вспомогательные функции
        function getCategoryColorClass(category) {
            const colors = {
                'Экология': 'bg-green-500',
                'Спорт': 'bg-red-500',
                'Образование': 'bg-blue-500',
                'Социальная помощь': 'bg-purple-500',
                'Благоустройство': 'bg-orange-500',
                'Культура': 'bg-pink-500'
            };
            return colors[category] || 'bg-blue-500';
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' });
        }

        function showNotification(message, type) {
            alert(message); // Временное решение, можно заменить на красивые уведомления
        }

        // Обработчик загрузки изображения
        document.getElementById('imageUploadArea').addEventListener('click', function() {
            document.getElementById('eventImage').click();
        });
    </script>
</body>
</html>